import sys
from langdetect import detect, LangDetectException
from tqdm import tqdm

# Import your storage wrapper
from model.storageModel import PineconeStorage


TOP_K = 3000        # how many to fetch
BATCH_SIZE = 100     # batch delete size


def fetch_all_records(storage):
    """Fetches records using an empty vector (Pinecone allows this)."""
    print(f"Fetching up to {TOP_K} records...")

    results = storage.index.query(
        vector=[-0.031051035970449448, -0.05342565476894379, -0.028117340058088303, -0.0005415405612438917, 0.026355359703302383, -0.04270553961396217, 0.017884667962789536, 0.0090569369494915, -0.021122759208083153, -0.018848132342100143, 0.022702069953083992, -0.004241722635924816, -0.05800732597708702, 0.04721248149871826, 0.023281443864107132, 0.055965032428503036, 0.024767298251390457, 0.023975834250450134, -0.021568231284618378, -0.00325119961053133, 0.048307180404663086, -0.003862324869260192, 0.02791621722280979, 0.04153989255428314, 0.04211397469043732, 0.01689898781478405, 0.03116113692522049, 0.054149895906448364, -0.017468003556132317, -0.0014780014753341675, 0.010771979577839375, 0.02690679021179676, 0.0014132478972896934, -0.0006311119650490582, 0.05538515746593475, -0.018540306016802788, 0.0012812638888135552, 0.025670643895864487, -0.021023428067564964, -0.04413685202598572, -0.031232982873916626, 0.03921474516391754, -0.007659559603780508, 0.048828091472387314, -0.018846148625016212, 0.018879810348153114, -0.00704546645283699, 0.014796789735555649, -0.012625519186258316, -0.028881993144750595, 0.00041941198287531734, 0.001340026268735528, 0.030828773975372314, -0.050766583532094955, -0.009024706669151783, 0.02320050820708275, 0.006072876043617725, -0.05877985060214996, -0.012424026615917683, -0.017448700964450836, -0.02953174151480198, 0.005379741545766592, -0.022657951340079308, 0.0010263047879561782, 0.021796276792883873, 0.011533183045685291, -0.009194539859890938, 0.006558361928910017, -0.050517261028289795, 0.02065354771912098, -0.04564882814884186, -0.0480077788233757, -0.014656957238912582, 0.00019725174934137613, 0.04998642951250076, -0.04890015348792076, -0.01039917953312397, 0.04455878958106041, 0.09501296281814575, 0.00770054804161191, -0.0011205682530999184, -0.02593250200152397, -0.026821717619895935, 0.03664945811033249, 0.03530046343803406, 0.04474661499261856, -0.012317772023379803, -0.05960187315940857, -0.05873725935816765, 0.04935905337333679, 0.008081723004579544, -0.043260615319013596, 0.014551304280757904, 0.045257896184921265, -0.003879025811329484, -0.0043434081599116325, 0.0316358357667923, -0.0174148790538311, -0.011255551129579544, 0.0026204076129943132, -0.07050489634275436, -0.04227183759212494, 0.017866645008325577, 0.00025499635376036167, -0.0630483329296112, 0.0004070789145771414, -0.03368937224149704, -0.018077418208122253, -0.03332884982228279, 0.028388727456331253, 0.0018912141676992178, 0.032215289771556854, 0.007921549491584301, 0.0007451928686350584, -0.05271562188863754, 0.07189950346946716, 0.04967532679438591, -0.018840834498405457, 0.03198707103729248, 0.015694087371230125, -0.01035009603947401, 0.0052639031782746315, -0.03229359909892082, 0.06408556550741196, -0.04320678859949112, -0.022921627387404442, -0.048797208815813065, 0.01043512299656868, -0.04455773904919624, -0.002744403900578618, 0.006009802687913179, -0.0018945292104035616, 0.0002968240878544748, -0.017770593985915184, 0.05119150131940842, 0.04288431257009506, 0.006258358713239431, -0.05016634240746498, 0.030142048373818398, 0.007810237817466259, -0.02177664265036583, 0.005239061079919338, -0.013188510201871395, -0.013266749680042267, 0.021208852529525757, -0.011310802772641182, 0.008986109867691994, -0.01582828350365162, 0.017949437722563744, 0.0815381184220314, -0.0007318166899494827, -0.0030947187915444374, -0.02780025824904442, 0.029857171699404716, -0.018300771713256836, 0.0317981019616127, -0.016060883179306984, -0.012853999622166157, -0.03074105642735958, 0.013261061161756516, 0.037790410220623016, -0.03192133083939552, 0.02911176159977913, -0.03500542417168617, 0.01773756742477417, 0.04204943776130676, 0.09859223663806915, -0.03354640305042267, -0.01862790249288082, -0.006098038051277399, -0.07128893584012985, -0.046615008264780045, 0.051418233662843704, -0.0752430260181427, 0.038885697722435, 0.01947910152375698, 0.06605962663888931, -0.026143763214349747, 0.009578799828886986, 0.008727621287107468, -0.03770055994391441, -0.006330506410449743, 0.003293946385383606, 0.0005171423545107245, 0.009535860270261765, -0.03587565943598747, 0.057079870253801346, 0.004037398844957352, 0.03400811180472374, 0.08052805066108704, -0.06728199124336243, -0.06649529933929443, 0.033643752336502075, -0.011709137819707394, 0.016729701310396194, 0.011203542351722717, -0.026521535590291023, 0.008157992735505104, -0.03060687519609928, 0.010092170909047127, -0.026118431240320206, -0.014504472725093365, -0.007613923866301775, -0.006951658986508846, -0.056467026472091675, 0.04897719994187355, 0.008878931403160095, -0.0510370098054409, -0.009444541297852993, 0.03503189608454704, 0.006360250990837812, 0.02961953729391098, 0.06645852327346802, -0.040918849408626556, 0.003984962590038776, 0.014685999602079391, 0.014611080288887024, 0.05038567632436752, -0.014178290963172913, -0.03803471848368645, 0.027568165212869644, -0.0051148924976587296, -0.05021919310092926, 0.06942930072546005, -0.028777433559298515, 0.06796514987945557, 0.036439716815948486, -0.02744201011955738, -0.00010210712207481265, -0.015932615846395493, 0.06721413880586624, -0.0027195517905056477, 0.046341292560100555, -0.0005930390325374901, -0.003073829459026456, -0.006344483699649572, 0.010794143192470074, -0.02825690433382988, 0.06532730162143707, -0.039424143731594086, 0.007581114768981934, 0.035103559494018555, -0.010943997651338577, 0.04177726432681084, 0.0667337104678154, 0.009869988076388836, 0.01749269850552082, 0.018572306260466576, -0.05258238688111305, -0.008305234834551811, 0.019960831850767136, -0.032300468534231186, -0.05057762935757637, -0.050840847194194794, -0.00694909505546093, -0.06570257991552353, 0.01713891699910164, -0.0034758932888507843, 0.038785383105278015, 0.009855075739324093, 0.03721245005726814, 0.0027666278183460236, -0.038318976759910583, 0.022781776264309883, 0.029459230601787567, -0.05831852927803993, -0.025692429393529892, -0.006984700448811054, 0.05296449735760689, -0.011594527401030064, -0.0036493984516710043, 0.005579792428761721, 0.02577057294547558, 0.028209680691361427, 0.040982961654663086, 0.017410703003406525, -0.007421247661113739, 0.0016595721244812012, -0.010964703746140003, -0.05128803476691246, 0.03678536415100098, 0.05249633640050888, -0.021332278847694397, 0.010705635882914066, -0.028811808675527573, -0.056862667202949524, -0.017581189051270485, -0.09029050916433334, -0.029668310657143593, 0.02619999647140503, -0.010982902720570564, 0.07372881472110748, 0.012522855773568153, 0.015265582129359245, -0.027430856600403786, 0.00021231973369140178, -0.046405959874391556, 0.03124833293259144, -0.024156883358955383, -0.013917328789830208, 0.034952566027641296, -0.0007372607360593975, -0.04326510801911354, -0.000364167703082785, 0.033977407962083817, -0.0667508989572525, 0.04019169881939888, -0.024418558925390244, -0.29090264439582825, 0.005998846609145403, 0.022934572771191597, -0.020742448046803474, 0.0038355563301593065, -0.09365952014923096, -0.022433336824178696, 0.0059367152862250805, -0.007193522062152624, -0.03382089361548424, -0.040256161242723465, -0.005538713652640581, 0.06981075555086136, 0.0034693183843046427, 0.08669230341911316, 0.05515874922275543, 0.04689612612128258, -0.03380874916911125, 0.010826307348906994, 0.02197279967367649, -0.016033433377742767, -0.06398234516382217, -0.03579240292310715, 0.027979230508208275, -0.028577495366334915, 0.02068786881864071, -0.06364127993583679, -0.03518619388341904, -0.020272497087717056, 0.010524081997573376, 0.04552319645881653, -0.08018095791339874, -0.0044214739464223385, 0.00594571465626359, 0.0379505418241024, 0.006201012991368771, 0.026366937905550003, 0.014839806593954563, 0.011277920566499233, -0.018068548291921616, 0.019968781620264053, -0.06913387030363083, 0.007024570368230343, 0.015438955277204514, 0.016956523060798645, 1.1363108569639735e-05, 0.041662782430648804, -0.04103247821331024, -0.043297842144966125, 0.04892045632004738, -0.01422413531690836, 0.02452530711889267, -0.03031424805521965, -0.008751214481890202, -0.020024938508868217, 0.018820973113179207, 0.030281871557235718, 0.011309271678328514, -0.015883974730968475, 0.008075379766523838, -0.026091473177075386, -0.01546241994947195, -0.030673695728182793, -0.011124848388135433, 0.009170744568109512, -0.03571513667702675, -0.0068126521073281765, -0.06938818842172623, 0.009707542136311531, -0.00956979300826788, -0.02077566832304001, -0.006558154709637165, 0.004302722867578268, -0.09163206070661545, -0.015496348030865192, 0.013007424771785736, -0.026344753801822662, 0.012050188146531582, -0.001188121736049652, 0.006307439412921667, -0.009390625171363354, -0.02017262391746044, 0.04876408353447914, -0.010619360953569412, 0.0035987505689263344, 0.015681440010666847, 0.020346255972981453, 0.00509276520460844, -0.01900155283510685, -0.018232593312859535, 0.026788152754306793, 0.008205178193747997, -0.01171493623405695, -0.0015836358070373535, 0.03030581586062908, 0.05524600297212601, -0.013988284394145012, 0.015155887231230736, 0.05422225967049599, -0.00432103406637907, 0.035482559353113174, -0.06046700477600098, 0.0217718705534935, -0.017695626243948936, 0.012088440358638763, -0.02484053373336792, -0.05357995256781578, -0.06891224533319473, 0.015282045118510723, 0.009298465214669704, 0.011182345449924469, 0.04990264028310776, 0.011868047527968884, -0.017368728294968605, 0.02927185781300068, -0.008813055232167244, 0.004664359148591757, 0.028834888711571693, 0.001086233532987535, -0.020690666511654854, -0.03859280049800873, 0.025720877572894096, 0.019178960472345352, 0.01861131191253662, 0.02292032726109028, -0.03416241705417633, 0.0028539891354739666, 0.043452657759189606, -0.007152772508561611, 0.02020455151796341, 0.04248320311307907, 0.03856300562620163, -0.038519974797964096, -0.011188638396561146, 0.07854296267032623, 0.01541011594235897, -0.06470350176095963, -0.026902232319116592, 0.002161184558644891, -0.009544880129396915, -0.023249059915542603, -0.03256855905056, -0.006793703883886337, -0.012751798145473003, 0.04040992259979248, 0.024743473157286644, -0.0219403263181448, 0.005130246747285128, 0.021771308034658432, 0.039952851831912994, -0.01374471839517355, -0.014623187482357025, 0.00412142276763916, -0.06549990177154541, 0.009894656017422676, -0.03537499159574509, 0.019365180283784866, 0.03238525986671448, -0.009407845325767994, -0.08354755491018295, 0.02016265131533146, -0.06978932023048401, 0.018606606870889664, 0.014183515682816505, -0.004077661316841841, 0.0969604030251503, 0.008083343505859375, -0.01487540453672409, -0.01071443036198616, 0.04824250191450119, -0.017149752005934715, -0.054792389273643494, 0.007407101336866617, 0.010597474873065948, -0.04473436623811722, 0.0084692956879735, -0.0012558705639094114, -0.01753106154501438, 0.008802512660622597, 0.01158464327454567, 0.0031112811993807554, -0.03870047628879547, -0.021619733422994614, 0.009084111079573631, 0.057906001806259155, 0.00903982762247324, -0.0650670975446701, -0.05975436419248581, -0.03172764927148819, -0.007198374718427658, -0.05396265164017677, 0.0067131416872143745, 0.024635639041662216, -0.017069032415747643, -0.045287564396858215, -0.10441486537456512, 0.03668203949928284, -0.0006149890832602978, -0.029738878831267357, -0.0022208443842828274, 0.002007794566452503, -0.005917172413319349, -0.04534955695271492, 0.048602063208818436, 0.040571991354227066, -0.08257059007883072, 0.02684558369219303, -0.0007945075049065053, 0.010310719721019268, 0.054744407534599304, 0.0392569936811924, -0.034509748220443726, -0.058254778385162354, 0.0370807908475399, 0.004959143232554197, -0.016340121626853943, -0.0027274207677692175, 0.011900678277015686, -0.01766471192240715, 0.023772764950990677, -0.024330444633960724, 0.012145333923399448, -0.04187437519431114, -0.001803914550691843, 0.02011783793568611, 0.02062428742647171, 0.03915891423821449, 0.00040486257057636976, -0.022840894758701324, -0.015594135969877243, 0.03113727644085884, -0.07892774045467377, 0.04291965812444687, 0.047342944890260696, -0.027642719447612762, 0.02443152293562889, -0.009493442252278328, 0.011999277397990227, 0.0071296971291303635, -0.014492729678750038, 0.037674542516469955, 0.03885510936379433, -0.01907082088291645, -0.006411574315279722, -0.02109927497804165, 0.0098642623052001, -0.0077004870399832726, 0.01778770610690117, 0.044650692492723465, 0.027955995872616768, 0.03405274823307991, -0.006513321306556463, 0.014449229463934898, 0.03958870470523834, 0.019054697826504707, -0.07838598638772964, -0.04214102402329445, -0.008955353870987892, -0.06597603112459183, 0.010268375277519226, 0.053423281759023666, -0.004174234811216593, 0.01809828355908394, 0.06977543979883194, -0.00027079778374172747, -0.016827838495373726, -0.018969908356666565, -0.041691552847623825, 0.04192870110273361, -0.036673981696367264, -0.01247002836316824, -0.014380470849573612, -0.010891797952353954, 0.09065862745046616, -0.04763556271791458, -0.0017641527811065316, -0.03169272094964981, -0.012167943641543388, -0.010245424695312977, -0.04454169422388077, -0.059153929352760315, -0.004032916855067015, 0.024253077805042267, 0.011632300913333893, -0.00709623983129859, -0.008834797888994217, 0.024926381185650826, -0.00493993004783988, -0.10613138228654861, -0.05645395442843437, 0.015070201829075813, 0.01520241517573595, -0.030425183475017548, -0.00520316744223237, 0.002603953005746007, 0.05379919707775116, 0.0821472704410553, 0.030423972755670547, 0.027457071468234062, 0.013997653499245644, -0.027644285932183266, 0.10161299258470535, 0.056527167558670044, -0.02860748954117298, -0.01333252340555191, -0.0025265133008360863, 0.017806487157940865, -0.05368809774518013, -0.021100303158164024, -0.01930084265768528, 0.0025317815598100424, -0.050179269164800644, 0.06272414326667786, 0.0262743029743433, -0.060605116188526154, 0.007903536781668663, -0.0168735571205616, -0.027390193194150925, -0.008251233026385307, -0.010208779945969582, 0.010024314746260643, -0.008691062219440937, 0.013450081460177898, -0.01676628738641739, 0.02113405428826809, 0.04966582730412483, -0.017444558441638947, 0.02296789549291134, -0.03312553092837334, 0.04018748924136162, 0.0745573490858078, -0.010788974352180958, -0.030528904870152473, 0.05474431440234184, -0.022540174424648285, -0.04526792839169502, 0.02313191071152687, -0.029560768976807594, -0.04422213137149811, 0.03182997182011604, 0.0007810129318386316, 0.0861862525343895, 0.023038655519485474, 0.01965663768351078, -0.03709723800420761, -0.0023650166112929583, 0.016737431287765503, 0.0011752237332984805, 0.02390478365123272, -0.0016525530954822898, 0.0036387473810464144, 0.0027550854720175266, -0.04654185473918915, -0.006825867109000683, -0.035303983837366104, 0.016128355637192726, 0.001506209489889443, 0.02400650642812252, -0.022717878222465515, 0.0144173763692379, -0.05005009472370148, -0.005736730061471462, 0.05588408559560776, -0.018211299553513527, -0.03521512821316719, 0.031794942915439606, -0.002686672145500779, -0.03850797191262245, 0.06312602758407593, 0.003365384414792061, -0.008312542922794819, 0.01666775345802307, 0.0009062375756911933, -0.0025328530464321375, -0.020050184801220894, 0.030963389202952385, 0.024279214441776276, -0.01140145305544138, -0.029888834804296494, 0.04118559882044792, 0.008587393909692764, -0.04097128286957741, 3.834100061794743e-05, -0.03210286423563957, -0.019743187353014946, -0.07033184915781021, -0.010263665579259396, -0.01666274480521679, -0.06013175845146179, -0.02722509577870369, 0.02023526281118393, -0.013503930531442165, -0.025370419025421143, 0.010816682130098343, -0.024846553802490234, -0.03416529670357704, 0.01890627294778824, 0.03244530409574509, 0.002333550015464425, -0.018290909007191658, 0.04193699359893799, 0.051226917654275894, -0.017147531732916832, 0.0031759862322360277, 0.003971195314079523, 0.013490450568497181, 0.012599023059010506, -0.005626540631055832, -0.07746705412864685, 0.025910770520567894, 0.021436480805277824, 0.014450493268668652, -0.017951099202036858, 0.018439481034874916, 0.0359351709485054, 0.050408173352479935, 0.045550741255283356, 0.0027564093470573425, 0.0003024690959136933, -0.02249736525118351, -0.023082731291651726, 0.0030208220705389977, -0.051284708082675934, 0.03892800584435463, -0.015299978666007519, 0.06754341721534729, -0.009033022448420525, -0.0018630465492606163, -0.014582031406462193, 0.06976965814828873, 0.037455424666404724, -0.03710778057575226, -0.03517184033989906, -0.01777752675116062, -0.07649808377027512, -0.08733972907066345, 0.012213383801281452, 0.008576150052249432, -0.03351261839270592, -0.011071130633354187, 0.045565273612737656, -0.022358974441885948, 0.08793725073337555, -0.01876460388302803, 0.013389483094215393, -0.000713264278601855, -0.06170012801885605, -0.05348823964595795, -0.06044067442417145, -0.00746939517557621, -0.021193617954850197, 0.02050049789249897, 0.06277444213628769, -8.604191680205986e-05, 0.062825046479702, -0.002862852066755295, 0.05394504591822624, -0.007141089532524347, 0.07101502269506454, 0.007184277288615704],    # empty / zero vector works for retrieving
        top_k=TOP_K,
        include_metadata=True
    )

    return results.get("matches", [])


def detect_non_english(records):
    """Scan records and collect IDs that are not English."""
    ids = []

    print("\nDetecting language...")
    for rec in tqdm(records, desc="Scanning", ncols=80):
        md = rec.get("metadata", {})
        text = md.get("text", "") or ""

        try:
            if detect(text) != "en":
                ids.append(rec["id"])
        except LangDetectException:
            ids.append(rec["id"])

    print(f"\nFound {len(ids)} non-English records.")
    return ids


def delete_in_batches(storage, ids):
    """Delete IDs in safe mini-batches."""
    if not ids:
        print("No records to delete.")
        return

    print("\nDeleting records...")
    for i in tqdm(range(0, len(ids), BATCH_SIZE), desc="Deleting", ncols=80):
        batch = ids[i:i + BATCH_SIZE]
        try:
            storage.index.delete(ids=batch)
        except Exception as e:
            print(f"Error deleting batch {batch}: {e}", file=sys.stderr)


def main():
    print("=== Pinecone Cleanup Script: Remove Non-English Records ===")

    # Initialize storage
    storage = PineconeStorage()
    storage.connect_to_index()

    # Step 1 — fetch
    records = fetch_all_records(storage)

    # Step 2 — detect non-English
    ids_to_delete = detect_non_english(records)

    # Step 3 — delete
    delete_in_batches(storage, ids_to_delete)

    print("\nCleanup complete!")


if __name__ == "__main__":
    main()
